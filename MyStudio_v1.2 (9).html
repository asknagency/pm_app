<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nuudesk - Studio v1.3</title>
    <link id="app-manifest" rel="manifest" href="" />

    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuidv4.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0f172a', // Slate 900
                            800: '#1e293b', // Slate 800
                            700: '#334155', // Slate 700
                            600: '#475569', 
                            50: '#ffffff'
                        },
                        brand: '#2563EB', // Blue 600
                        brandHover: '#1d4ed8', // Blue 700
                        brandLight: '#eff6ff', // Blue 50
                    },
                    fontSize: {
                        'xxs': '0.65rem',
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus/theme-chalk/dark/css-vars.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>

    <style>
        :root {
            /* SHARP EDGES / DENSITY OVERRIDES */
            --el-border-radius-base: 3px;
            --el-border-radius-small: 2px;
            --el-border-radius-round: 4px;
            --el-component-size-small: 26px; /* Slightly tighter */
            
            /* DEEP BLUE THEME OVERRIDES */
            --el-color-primary: #2563EB; /* Blue 600 */
            --el-color-primary-light-3: #60a5fa;
            --el-color-primary-light-5: #93c5fd;
            --el-color-primary-light-7: #bfdbfe;
            --el-color-primary-light-8: #dbeafe;
            --el-color-primary-light-9: #eff6ff;
            --el-color-primary-dark-2: #1d4ed8;
            
            --el-font-size-base: 13px;
        }

        /* Scrollbar refined */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--el-border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--el-text-color-secondary); }

        body { 
            background-color: var(--el-bg-color); 
            color: var(--el-text-color-primary); 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            font-size: 13px;
            transition: background-color 0.3s, color 0.3s;
        }

        .dashboard-card {
            background: var(--el-bg-color-overlay);
            border: 1px solid var(--el-border-color-light);
            border-radius: 3px;
            transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out;
            position: relative;
        }
        .dashboard-card:hover {
            border-color: var(--el-color-primary);
        }

        /* Timeline Layout */
        .timeline-container {
            display: flex;
            height: 100%;
            overflow-x: auto;
            scroll-behavior: smooth;
        }
        .timeline-col {
            min-width: 290px;
            max-width: 290px;
            border-right: 1px solid var(--el-border-color-lighter);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background-color: var(--el-fill-color-blank);
            transition: background-color 0.5s ease;
        }
        .timeline-col:nth-child(even) {
            background-color: var(--el-fill-color-lighter);
        }
        
        .current-day-highlight {
            background: var(--el-color-primary-light-9) !important;
            border-top: 2px solid var(--el-color-primary);
        }
        
        /* Dark Mode adjustments */
        .dark .current-day-highlight {
            background: rgba(37, 99, 235, 0.1) !important;
        }
        
        @keyframes flash-anim {
            0% { background-color: var(--el-color-primary-light-5); }
            100% { background-color: inherit; }
        }
        .flash-highlight {
            animation: flash-anim 1.5s ease-out !important;
        }
        .dark .flash-highlight {
            animation: flash-anim-dark 1.5s ease-out !important;
        }
        @keyframes flash-anim-dark {
            0% { background-color: rgba(37, 99, 235, 0.4); }
            100% { background-color: inherit; }
        }

        /* Element Plus Dialog Tweaks */
        .el-dialog { border-radius: 4px !important; }
        .el-button { border-radius: 3px !important; font-weight: 500; }
        .el-input__wrapper, .el-select__wrapper, .el-textarea__inner { 
            border-radius: 3px !important; 
            box-shadow: 0 0 0 1px var(--el-border-color) inset !important; 
        }
        .el-tag { border-radius: 3px !important; }

        /* Custom Date Picker Styling */
        .month-picker-custom {
            width: 110px !important;
        }
        .month-picker-custom .el-input__wrapper {
            box-shadow: none !important;
            background-color: transparent !important;
            padding: 0 !important;
        }
        .month-picker-custom .el-input__inner {
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            color: var(--el-text-color-primary);
            height: 24px;
        }
        .month-picker-custom .el-input__inner:hover {
            color: var(--el-color-primary);
        }
        .month-picker-custom .el-input__prefix, 
        .month-picker-custom .el-input__suffix {
            display: none;
        }

        .tag-icon-img {
            width: 14px;
            height: 14px;
            object-fit: contain;
            display: block;
        }
        img { text-indent: -10000px; }
        
        .notification-dot {
            position: absolute;
            top: 0;
            right: 0;
            width: 6px;
            height: 6px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 1px solid var(--el-bg-color);
        }

        /* Timer Widget Animation */
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }
        .timer-active {
            animation: pulse-border 2s infinite;
        }

        /* Animations */
        .splash-fade-leave-active {
            transition: opacity 0.5s ease;
        }
        .splash-fade-leave-to {
            opacity: 0;
        }
        
        .card-menu-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .dashboard-card:hover .card-menu-btn {
            opacity: 1;
        }

        /* Focus View Transitions */
        .focus-enter-active,
        .focus-leave-active {
            transition: all 0.2s ease;
        }
        .focus-enter-from,
        .focus-leave-to {
            opacity: 0;
            transform: translateY(10px);
        }

        /* Doc View Specifics */
        .doc-property-grid {
            display: grid;
            grid-template-columns: 100px 1fr;
            align-items: center;
            row-gap: 8px;
        }
        .doc-textarea .el-textarea__inner {
            box-shadow: none !important;
            padding: 0 !important;
            background-color: transparent !important;
            font-size: 15px;
            line-height: 1.6;
            color: var(--el-text-color-primary);
        }
        .doc-input-transparent .el-input__wrapper {
            box-shadow: none !important;
            background: transparent !important;
            padding-left: 0;
        }
    </style>
</head>

<body>

    <div id="app" class="h-screen flex flex-col relative transition-colors duration-300">

        <transition name="splash-fade">
            <div v-if="isAppLoading" class="fixed inset-0 z-[9999] bg-[var(--el-bg-color)] flex flex-col items-center justify-center">
                <div class="flex flex-col items-center gap-4">
                    <div class="w-16 h-16 rounded-md bg-brand flex items-center justify-center text-white shadow-xl animate-bounce">
                        <img v-if="appSettings.appIcon" :src="appSettings.appIcon" class="w-full h-full object-cover rounded-md" />
                        <span v-else class="font-black text-xl tracking-tighter">Nuu</span>
                    </div>
                    <div class="text-center">
                        <h2 class="text-lg font-bold text-[var(--el-text-color-primary)] tracking-wide">NUUDESK</h2>
                        <p class="text-xs text-[var(--el-text-color-secondary)] mt-1 font-mono">Loading Studio v1.3...</p>
                    </div>
                    <div class="w-32 h-1 bg-[var(--el-fill-color-dark)] rounded-full overflow-hidden mt-4">
                        <div class="h-full bg-brand animate-pulse w-full"></div>
                    </div>
                </div>
            </div>
        </transition>

        <header class="h-10 bg-[var(--el-bg-color)] border-b border-[var(--el-border-color)] flex items-center justify-between px-3 shrink-0 z-30">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-sm bg-brand flex items-center justify-center text-white shadow-sm overflow-hidden shrink-0">
                    <img v-if="appSettings.appIcon" :src="appSettings.appIcon" class="w-full h-full object-cover" />
                    <span v-else class="font-black text-[9px] tracking-tighter">Nuu</span>
                </div>
                <div class="flex items-baseline gap-2">
                    <h1 class="text-xs font-bold text-[var(--el-text-color-primary)] uppercase tracking-wide">Nuudesk <span class="text-[var(--el-text-color-secondary)] font-normal text-[9px] ml-1">v1.3</span></h1>
                    <div class="text-[9px] text-[var(--el-text-color-placeholder)] font-mono">
                        SYNC: <span :class="githubConfigured ? 'text-green-500' : 'text-red-500'">{{ githubConfigured ? 'ON' : 'OFF' }}</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 items-center">
                <el-popover placement="bottom" :width="300" trigger="click">
                    <template #reference>
                        <div class="relative cursor-pointer w-6 h-6 flex items-center justify-center hover:bg-[var(--el-fill-color)] rounded-sm transition-colors">
                            <el-icon class="text-[var(--el-text-color-secondary)] hover:text-brand"><bell /></el-icon>
                            <span v-if="notificationList.length > 0" class="notification-dot"></span>
                        </div>
                    </template>
                    <div class="p-1">
                        <div class="text-[10px] font-bold uppercase text-[var(--el-text-color-placeholder)] mb-2 flex justify-between">
                            <span>Attention Needed</span>
                            <span>{{ notificationList.length }}</span>
                        </div>
                        <div v-if="notificationList.length === 0" class="text-center py-4 text-[var(--el-text-color-secondary)] text-xs">
                            <el-icon class="mb-1"><circle-check /></el-icon><br>All caught up!
                        </div>
                        <div v-else class="max-h-60 overflow-y-auto space-y-1">
                            <div v-for="note in notificationList" :key="note.id" 
                                 class="p-2 bg-[var(--el-fill-color-light)] rounded-sm border-l-2 border-red-500 cursor-pointer hover:bg-[var(--el-fill-color)]"
                                 @click="toggleFocusMode(note); goToToday();">
                                <div class="text-xs font-medium truncate">{{ note.title }}</div>
                                <div class="text-[9px] text-red-500 flex items-center gap-1 mt-0.5">
                                    <el-icon><warning /></el-icon>
                                    {{ note.isOverdue ? 'Overdue' : 'Due Today' }} ({{ note.date }})
                                </div>
                            </div>
                        </div>
                    </div>
                </el-popover>

                <div class="h-3 w-[1px] bg-[var(--el-border-color)] mx-1"></div>

                 <el-button link size="small" @click="toggleTheme">
                    <el-icon v-if="appSettings.theme === 'dark'" class="text-yellow-400"><sunny /></el-icon>
                    <el-icon v-else class="text-gray-500"><moon /></el-icon>
                </el-button>
                <el-button link size="small" @click="showSettingsModal = true" class="!text-[var(--el-text-color-secondary)] hover:!text-[var(--el-color-primary)]">
                    <el-icon><setting /></el-icon>
                </el-button>
            </div>
        </header>

        <main class="flex-1 overflow-hidden relative flex flex-col bg-[var(--el-bg-color-page)]">
            
            <div v-if="!githubConfigured" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 text-center bg-[var(--el-overlay-color-lighter)] backdrop-blur-sm">
                <div class="w-12 h-12 rounded-sm border border-[var(--el-border-color)] bg-[var(--el-bg-color)] flex items-center justify-center mb-3">
                    <el-icon class="text-xl text-[var(--el-text-color-secondary)]"><folder-opened /></el-icon>
                </div>
                <h3 class="text-sm font-bold text-[var(--el-text-color-primary)]">Connect Workspace</h3>
                <p class="text-xs text-[var(--el-text-color-secondary)] mt-1 mb-4">Connect GitHub to load your tasks and settings.</p>
                <el-button type="primary" size="small" @click="showSettingsModal = true">
                    Configure Backend
                </el-button>
            </div>

            <div v-else class="flex-1 flex flex-col h-full">
                
                <div class="h-12 border-b border-[var(--el-border-color)] flex items-center justify-between px-4 shrink-0 bg-[var(--el-bg-color)] shadow-sm z-20">
                    
                    <div class="flex items-center gap-4">
                        
                        <div v-if="!activeFocusTask" class="flex items-center bg-[var(--el-fill-color-light)] rounded-md border border-[var(--el-border-color-light)] p-0.5 shadow-sm">
                            <el-button text size="small" class="!w-6 !h-6 !px-0 rounded-sm" @click="changeMonth(-1)">
                                <el-icon><arrow-left /></el-icon>
                            </el-button>
                            
                            <div class="w-24 flex justify-center">
                                <el-date-picker
                                    v-model="viewDate"
                                    type="month"
                                    :clearable="false"
                                    :editable="false"
                                    format="MMM YYYY"
                                    class="month-picker-custom"
                                    :popper-options="{ modifiers: [{ name: 'offset', options: { offset: [0, 8] } }] }"
                                />
                            </div>

                            <el-button text size="small" class="!w-6 !h-6 !px-0 rounded-sm" @click="changeMonth(1)">
                                <el-icon><arrow-right /></el-icon>
                            </el-button>
                        </div>

                        <div v-if="!activeFocusTask" class="h-4 w-[1px] bg-[var(--el-border-color)]"></div>

                        <div v-if="!activeFocusTask" class="flex items-center gap-1">
                            <el-tooltip content="Go to Today" placement="bottom" :show-after="400">
                                <el-button text circle size="small" @click="goToToday" class="!w-8 !h-8 hover:bg-[var(--el-fill-color)]">
                                    <el-icon class="text-[var(--el-text-color-secondary)] hover:text-brand transition-colors text-sm"><calendar /></el-icon>
                                </el-button>
                            </el-tooltip>
                        </div>
                        
                        <div v-if="activeFocusTask" class="flex items-center gap-2">
                            <el-button @click="closeFocusMode" size="small" link class="!text-[var(--el-text-color-secondary)] hover:!text-brand">
                                <el-icon class="mr-1"><back /></el-icon> Back to Board
                            </el-button>
                            <div class="h-3 w-[1px] bg-[var(--el-border-color)]"></div>
                            <span class="text-xs text-[var(--el-text-color-disabled)] font-mono">
                                Last edited: Just now
                            </span>
                        </div>
                    </div>
                    
                    <div v-if="!activeFocusTask" class="flex bg-[var(--el-fill-color-light)] p-0.5 rounded-full border border-[var(--el-border-color-light)]">
                        <el-tooltip content="Timeline" placement="bottom" :show-after="500">
                            <div @click="viewMode = 'timeline'" 
                                 class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer transition-all"
                                 :class="viewMode === 'timeline' ? 'bg-[var(--el-bg-color)] shadow-sm text-brand' : 'text-[var(--el-text-color-secondary)] hover:text-[var(--el-text-color-primary)]'">
                                <el-icon><data-analysis /></el-icon>
                            </div>
                        </el-tooltip>
                        <el-tooltip content="List View" placement="bottom" :show-after="500">
                            <div @click="viewMode = 'list'" 
                                 class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer transition-all"
                                 :class="viewMode === 'list' ? 'bg-[var(--el-bg-color)] shadow-sm text-brand' : 'text-[var(--el-text-color-secondary)] hover:text-[var(--el-text-color-primary)]'">
                                <el-icon><list /></el-icon>
                            </div>
                        </el-tooltip>
                         <div class="w-[1px] bg-[var(--el-border-color)] my-1 mx-0.5"></div>
                         <el-tooltip content="Projects" placement="bottom" :show-after="500">
                            <div @click="viewMode = 'projects'" 
                                 class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer transition-all"
                                 :class="viewMode === 'projects' ? 'bg-[var(--el-bg-color)] shadow-sm text-brand' : 'text-[var(--el-text-color-secondary)] hover:text-[var(--el-text-color-primary)]'">
                                <el-icon><folder /></el-icon>
                            </div>
                        </el-tooltip>
                    </div>
                    <div v-else class="flex items-center gap-2">
                         <el-button v-if="activeFocusTask.itemType === 'task'" circle size="small" @click="quickStartTimer(activeFocusTask)">
                             <el-icon class="text-[var(--el-text-color-secondary)] hover:text-brand"><timer /></el-icon>
                         </el-button>
                         <el-dropdown trigger="click">
                            <el-button circle size="small"><el-icon><more-filled /></el-icon></el-button>
                            <template #dropdown>
                                <el-dropdown-menu>
                                    <el-dropdown-item @click="cloneTask(activeFocusTask)">Clone</el-dropdown-item>
                                    <el-dropdown-item class="!text-red-500" @click="quickDeleteTask(activeFocusTask.id)">Delete</el-dropdown-item>
                                </el-dropdown-menu>
                            </template>
                        </el-dropdown>
                    </div>

                </div>

                <div v-if="!activeFocusTask && viewMode !== 'projects'" class="h-9 border-b border-[var(--el-border-color)] flex items-center px-3 shrink-0 bg-[var(--el-fill-color-light)] gap-3 overflow-x-auto">
                    <div class="flex items-center gap-1 border-r border-[var(--el-border-color)] pr-3">
                        <el-button size="small" link @click="showTagManager = true">
                            <el-icon class="mr-1"><price-tag /></el-icon> Tags
                        </el-button>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-[9px] text-[var(--el-text-color-placeholder)] font-bold uppercase mr-1">Filter:</span>
                        <div class="flex bg-[var(--el-bg-color)] border border-[var(--el-border-color)] rounded-sm p-[1px]">
                            <button @click="filterType = 'all'" :class="filterType === 'all' ? 'bg-[var(--el-color-primary-light-9)] text-[var(--el-color-primary)] font-bold' : 'text-[var(--el-text-color-secondary)]'" class="px-2 py-[1px] rounded-[1px] text-[10px] transition-colors">All</button>
                            <button @click="filterType = 'task'" :class="filterType === 'task' ? 'bg-blue-500/10 text-blue-500 font-bold' : 'text-[var(--el-text-color-secondary)]'" class="px-2 py-[1px] rounded-[1px] text-[10px] transition-colors">Tasks</button>
                            <button @click="filterType = 'note'" :class="filterType === 'note' ? 'bg-yellow-500/10 text-yellow-500 font-bold' : 'text-[var(--el-text-color-secondary)]'" class="px-2 py-[1px] rounded-[1px] text-[10px] transition-colors">Notes</button>
                        </div>
                    </div>
                    <div class="flex-1"></div>
                    <div>
                        <el-dropdown trigger="click" @command="(cmd) => openTaskModal(null, cmd)">
                            <el-button type="primary" size="small" circle>
                                <el-icon><plus /></el-icon>
                            </el-button>
                            <template #dropdown>
                                <el-dropdown-menu>
                                    <el-dropdown-item command="task"><el-icon><circle-check /></el-icon> New Task</el-dropdown-item>
                                    <el-dropdown-item command="note"><el-icon><notebook /></el-icon> New Note</el-dropdown-item>
                                    <el-dropdown-item command="idea"><el-icon><sunny /></el-icon> New Idea</el-dropdown-item>
                                </el-dropdown-menu>
                            </template>
                        </el-dropdown>
                    </div>
                </div>

                <transition name="focus">
                <div v-if="activeFocusTask" class="flex-1 overflow-hidden flex flex-col bg-[var(--el-bg-color-page)] relative">
                    <div class="w-full h-full overflow-y-auto custom-scrollbar">
                        
                        <div class="h-40 w-full bg-gradient-to-b from-[var(--el-fill-color-darker)] to-[var(--el-bg-color-page)] border-b border-[var(--el-border-color-lighter)] relative">
                            <div class="max-w-3xl mx-auto h-full flex flex-col justify-end px-8 pb-4 relative">
                                <div class="w-16 h-16 rounded-md bg-[var(--el-bg-color)] shadow-sm border border-[var(--el-border-color-lighter)] flex items-center justify-center text-3xl absolute -bottom-8 left-8 z-10">
                                    <span v-if="activeFocusTask.itemType === 'note'">ðŸ“’</span>
                                    <span v-else-if="activeFocusTask.itemType === 'idea'">ðŸ’¡</span>
                                    <span v-else>âœ…</span>
                                </div>
                            </div>
                        </div>

                        <div class="max-w-3xl mx-auto w-full pt-12 px-8 pb-32">
                            
                            <input v-model="activeFocusTask.title" 
                                   class="text-4xl font-extrabold bg-transparent border-none outline-none text-[var(--el-text-color-primary)] placeholder-[var(--el-text-color-placeholder)] w-full mb-6 leading-tight" 
                                   placeholder="Untitled" 
                                   @blur="saveFocusTask" />

                            <div class="text-xs text-[var(--el-text-color-regular)] doc-property-grid mb-8">
                                
                                <div class="text-[var(--el-text-color-secondary)] flex items-center gap-1"><el-icon><circle-check /></el-icon> Status</div>
                                <div>
                                    <div @click="toggleStatus(activeFocusTask)" class="inline-flex items-center px-2 py-0.5 rounded-sm text-xs font-medium cursor-pointer transition-colors"
                                         :class="activeFocusTask.status === 'done' ? 'bg-green-500/10 text-green-600' : 'bg-gray-500/10 text-gray-600 hover:bg-gray-500/20'">
                                        {{ activeFocusTask.status === 'done' ? 'Done' : 'In Progress' }}
                                    </div>
                                </div>

                                <div class="text-[var(--el-text-color-secondary)] flex items-center gap-1"><el-icon><calendar /></el-icon> Due Date</div>
                                <div class="doc-input-transparent">
                                     <span class="text-xs font-mono underline decoration-dotted decoration-[var(--el-border-color)] cursor-pointer hover:text-brand">{{ activeFocusTask.date }}</span>
                                </div>

                                <div class="text-[var(--el-text-color-secondary)] flex items-center gap-1"><el-icon><folder /></el-icon> Project</div>
                                <div>
                                    <span v-if="activeFocusTask.projectId" class="text-xs px-2 py-0.5 rounded-sm font-bold tracking-tight uppercase"
                                          :class="getProjectTypeColor(activeFocusTask.projectId)">
                                        {{ getProjectName(activeFocusTask.projectId) }}
                                    </span>
                                    <span v-else class="text-[var(--el-text-color-placeholder)] italic">Empty</span>
                                </div>

                                <div class="text-[var(--el-text-color-secondary)] flex items-center gap-1"><el-icon><price-tag /></el-icon> Tags</div>
                                <div class="flex gap-1 flex-wrap">
                                    <div v-if="activeFocusTask.tagId" class="flex items-center gap-1 bg-[var(--el-fill-color)] px-1.5 py-0.5 rounded-sm border border-[var(--el-border-color)]">
                                        <img :src="getTagIcon(activeFocusTask.tagId)" class="w-3 h-3 object-contain" @error="handleImgError" />
                                        <span class="text-[10px] font-bold uppercase">{{ getTagName(activeFocusTask.tagId) }}</span>
                                    </div>
                                    <span v-else class="text-[var(--el-text-color-placeholder)] italic">--</span>
                                </div>

                                <template v-if="activeFocusTask.itemType === 'task'">
                                    <div class="text-[var(--el-text-color-secondary)] flex items-center gap-1"><el-icon><clock /></el-icon> Estimate</div>
                                    <div>
                                        <input v-model="activeFocusTask.timeEstimate" class="bg-transparent border-none outline-none w-20 text-xs hover:bg-[var(--el-fill-color)] rounded px-1" placeholder="e.g. 1h" @blur="saveFocusTask" />
                                    </div>
                                </template>
                            </div>

                            <hr class="border-[var(--el-border-color-lighter)] mb-8">

                            <div class="min-h-[300px]">
                                <el-input 
                                    v-model="focusTaskNotesComputed"
                                    type="textarea"
                                    :autosize="{ minRows: 15 }"
                                    placeholder="Type your notes, ideas, or description here..."
                                    class="doc-textarea w-full"
                                    @blur="saveFocusTask"
                                />
                            </div>

                            <div class="mt-12 pt-4 border-t border-[var(--el-border-color-lighter)]">
                                <h4 class="text-[10px] font-bold uppercase text-[var(--el-text-color-placeholder)] mb-3">References & Files</h4>
                                <div class="flex flex-wrap gap-2">
                                     <div v-for="(file, idx) in activeFocusTask.files" :key="idx" class="text-xs bg-[var(--el-fill-color)] text-[var(--el-text-color-regular)] px-3 py-2 rounded-md flex items-center gap-2 border border-[var(--el-border-color)] cursor-pointer hover:border-brand transition-colors">
                                        <el-icon><paperclip /></el-icon>
                                        <span class="max-w-[200px] truncate">{{ file.name }}</span>
                                     </div>
                                     <div v-if="!activeFocusTask.files || activeFocusTask.files.length === 0" class="text-xs text-[var(--el-text-color-disabled)] italic">No attachments.</div>
                                </div>
                             </div>

                        </div>
                    </div>
                </div>
                </transition>

                <div v-if="!activeFocusTask && viewMode === 'timeline'" class="timeline-container custom-scrollbar bg-[var(--el-bg-color-page)] pb-32" id="timelineScrollContainer">
                    <div v-for="day in calendarDays" :key="day.dateStr" 
                         :id="'day-' + day.dateStr"
                         class="timeline-col p-1.5 relative group"
                         :class="{ 'current-day-highlight': day.isToday }">
                        
                        <div class="flex items-center justify-between mb-2 pb-1 border-b border-[var(--el-border-color-lighter)] px-1">
                            <div class="flex items-baseline gap-1.5">
                                <div class="text-xs font-bold text-[var(--el-text-color-primary)] font-mono">
                                    {{ day.displayDate }}
                                </div>
                                <div class="text-[9px] font-bold uppercase tracking-wider" :class="day.isToday ? 'text-brand' : 'text-[var(--el-text-color-placeholder)]'">
                                    {{ day.dayName }}
                                </div>
                            </div>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                <el-dropdown trigger="click" @command="(cmd) => openTaskModal(day.dateStr, cmd)" placement="bottom-end">
                                    <el-button size="small" text circle class="!h-5 !w-5">
                                        <el-icon class="text-xs"><plus /></el-icon>
                                    </el-button>
                                    <template #dropdown>
                                        <el-dropdown-menu>
                                            <el-dropdown-item command="task">Task</el-dropdown-item>
                                            <el-dropdown-item command="note">Note</el-dropdown-item>
                                            <el-dropdown-item command="idea">Idea</el-dropdown-item>
                                        </el-dropdown-menu>
                                    </template>
                                </el-dropdown>
                            </div>
                        </div>

                        <div class="flex-1 space-y-1.5 overflow-y-auto custom-scrollbar px-0.5 pb-10">
                            <div v-for="task in getTasksForDate(day.dateStr)" :key="task.id" 
                                 class="dashboard-card cursor-pointer relative overflow-hidden flex flex-col"
                                 @click="toggleFocusMode(task)">
                                
                                <div class="p-1.5 flex flex-col gap-1">
                                    <div class="flex items-center justify-between mb-0.5">
                                        <span v-if="task.projectId" class="text-[8px] px-1 py-[1px] rounded-[2px] font-mono font-bold tracking-tight uppercase"
                                              :class="getProjectTypeColor(task.projectId)">
                                            {{ getProjectName(task.projectId) }}
                                        </span>
                                        <span v-else class="text-[8px] px-1 py-[1px] rounded-[2px] font-mono font-bold bg-[var(--el-fill-color)] text-[var(--el-text-color-secondary)] uppercase">
                                            Inbox
                                        </span>

                                        <div class="flex items-center gap-1 text-[var(--el-text-color-secondary)]">
                                            <el-icon v-if="task.recurrence === 'daily'" class="text-[8px]"><refresh-right /></el-icon>
                                            <el-icon v-if="task.recurrence === 'weekly'" class="text-[8px]"><calendar /></el-icon>
                                            <el-icon v-if="activeTimer.taskId === task.id" class="text-brand animate-pulse text-[9px]"><timer /></el-icon>
                                            
                                            <div class="card-menu-btn" @click.stop>
                                                <el-dropdown trigger="click" placement="bottom-end">
                                                    <span class="el-dropdown-link"><el-icon class="text-[10px] hover:text-[var(--el-color-primary)]"><more-filled /></el-icon></span>
                                                    <template #dropdown>
                                                        <el-dropdown-menu>
                                                            <el-dropdown-item @click="toggleStatus(task)">
                                                                {{ task.status === 'done' ? 'Undo' : 'Done' }}
                                                            </el-dropdown-item>
                                                            <el-dropdown-item @click="cloneTask(task)">Clone</el-dropdown-item>
                                                            <el-dropdown-item class="!text-red-500" @click="quickDeleteTask(task.id)">Delete</el-dropdown-item>
                                                        </el-dropdown-menu>
                                                    </template>
                                                </el-dropdown>
                                            </div>
                                        </div>
                                    </div>

                                    <h4 class="text-[11px] font-medium text-[var(--el-text-color-primary)] leading-tight line-clamp-2" :class="{'line-through opacity-50': task.status === 'done'}">
                                        <el-icon v-if="task.itemType === 'note'" class="text-yellow-500 mr-0.5 text-[9px]"><notebook /></el-icon>
                                        <el-icon v-if="task.itemType === 'idea'" class="text-teal-400 mr-0.5 text-[9px]"><sunny /></el-icon>
                                        {{ task.title }}
                                    </h4>
                                    
                                    <div v-if="task.notes && task.notes.length > 0" class="text-[9px] text-[var(--el-text-color-secondary)] line-clamp-2 leading-tight opacity-75">
                                        {{ task.notes.join(' ') }}
                                    </div>

                                    <div class="flex items-center justify-between text-[9px] text-[var(--el-text-color-placeholder)] mt-0.5 pt-1 border-t border-[var(--el-border-color-lighter)]">
                                        <div v-if="task.tagId" class="flex items-center gap-1 bg-[var(--el-fill-color)] px-1 py-0.5 rounded-[2px] max-w-[70%] transform origin-left scale-95">
                                            <img :src="getTagIcon(task.tagId)" class="w-3 h-3 object-contain" alt="tag" @error="handleImgError" />
                                            <span class="text-[8px] font-bold uppercase truncate">{{ getTagName(task.tagId) }}</span>
                                        </div>
                                        <div v-else></div>

                                        <div v-if="task.itemType === 'task'" class="flex items-center gap-0.5 font-mono text-[8px]">
                                            <el-icon><clock /></el-icon> {{ task.timeEstimate || '--' }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="!activeFocusTask && viewMode === 'list'" class="flex-1 overflow-y-auto custom-scrollbar p-4 bg-[var(--el-bg-color-page)] pb-32">
                    <div class="max-w-3xl mx-auto space-y-6">
                        <div v-for="group in listViewGroups" :key="group.dateLabel">
                            <h3 class="text-[10px] font-bold text-[var(--el-text-color-placeholder)] uppercase tracking-widest mb-2 pl-2 border-l-2 border-brand sticky top-0 bg-[var(--el-bg-color-page)] py-1 z-10">
                                {{ group.dateLabel }}
                            </h3>
                            <div class="space-y-1">
                                <div v-for="task in group.tasks" :key="task.id" 
                                     class="dashboard-card relative flex flex-col group transition-all cursor-pointer hover:bg-[var(--el-fill-color-light)]"
                                     @click="toggleFocusMode(task)">
                                    
                                    <div class="p-2 flex items-center gap-3">
                                        <div class="shrink-0 w-8 h-8 rounded-sm flex items-center justify-center bg-[var(--el-fill-color)] border border-[var(--el-border-color-lighter)]">
                                            <el-icon v-if="task.itemType === 'note'" class="text-yellow-500"><notebook /></el-icon>
                                            <el-icon v-else-if="task.itemType === 'idea'" class="text-teal-400"><sunny /></el-icon>
                                            <div v-else @click.stop="toggleStatus(task)" class="cursor-pointer transition-colors" :class="task.status === 'done' ? 'text-green-500' : 'text-[var(--el-text-color-disabled)] hover:text-brand'">
                                                <el-icon v-if="task.status === 'done'"><circle-check-filled /></el-icon>
                                                <el-icon v-else><circle-check /></el-icon>
                                            </div>
                                        </div>

                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-0.5">
                                                <div v-if="task.tagId" class="w-3.5 h-3.5 flex items-center justify-center">
                                                    <img :src="getTagIcon(task.tagId)" class="tag-icon-img opacity-80" @error="handleImgError" />
                                                </div>
                                                <h4 class="text-xs font-medium text-[var(--el-text-color-primary)] truncate" :class="{'line-through text-[var(--el-text-color-secondary)]': task.status === 'done'}">{{ task.title }}</h4>
                                                 <el-icon v-if="activeTimer.taskId === task.id" class="text-brand animate-pulse"><timer /></el-icon>
                                            </div>
                                            <div v-if="task.notes && task.notes.length > 0" class="text-[10px] text-[var(--el-text-color-secondary)] line-clamp-1 opacity-70">
                                                {{ task.notes.join(' ') }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="!activeFocusTask && viewMode === 'projects'" class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-[var(--el-bg-color-page)] pb-32">
                    <div class="max-w-5xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-bold text-[var(--el-text-color-primary)]">Projects</h2>
                            <el-button type="primary" size="small" @click="showProjectModal = true">
                                <el-icon class="mr-1"><plus /></el-icon> New Project
                            </el-button>
                        </div>

                        <div v-if="projects.length === 0" class="text-center py-12 text-[var(--el-text-color-placeholder)] border-2 border-dashed border-[var(--el-border-color)] rounded-sm">
                            <el-icon class="text-4xl mb-2"><folder /></el-icon>
                            <p class="text-sm">No projects created yet.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="proj in projects" :key="proj.id" class="dashboard-card p-4 flex flex-col h-full group">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 rounded-sm flex items-center justify-center text-xs font-bold uppercase text-white" 
                                             :class="proj.type === 'Design' ? 'bg-blue-500' : proj.type === 'Development' ? 'bg-purple-500' : 'bg-pink-500'">
                                            {{ proj.title.substring(0,1) }}
                                        </div>
                                        <div>
                                            <h3 class="text-sm font-bold text-[var(--el-text-color-primary)] truncate max-w-[140px]" :title="proj.title">{{ proj.title }}</h3>
                                            <p class="text-[10px] text-[var(--el-text-color-secondary)]">{{ proj.type }}</p>
                                        </div>
                                    </div>
                                    <el-dropdown trigger="click">
                                        <span class="el-dropdown-link">
                                            <el-icon class="text-[var(--el-text-color-secondary)] cursor-pointer hover:text-[var(--el-color-primary)]"><more-filled /></el-icon>
                                        </span>
                                        <template #dropdown>
                                            <el-dropdown-menu>
                                                <el-dropdown-item @click="deleteProject(proj.id)" class="!text-red-500"><el-icon><delete /></el-icon> Delete</el-dropdown-item>
                                            </el-dropdown-menu>
                                        </template>
                                    </el-dropdown>
                                </div>

                                <div class="flex-1 mt-2 space-y-2">
                                    <div class="flex items-center gap-2 text-[10px] text-[var(--el-text-color-regular)]">
                                        <el-icon><user /></el-icon> {{ proj.owner || 'No Owner' }}
                                    </div>
                                    <div class="flex items-center gap-2 text-[10px] text-[var(--el-text-color-regular)]">
                                        <el-icon><suitcase /></el-icon> {{ proj.client || 'No Client' }}
                                    </div>
                                    <div v-if="proj.email" class="flex items-center gap-2 text-[10px] text-[var(--el-text-color-regular)] truncate">
                                        <el-icon><message /></el-icon> {{ proj.email }}
                                    </div>
                                </div>

                                <div class="mt-4 pt-3 border-t border-[var(--el-border-color-lighter)]">
                                    <div class="flex justify-between text-[10px] text-[var(--el-text-color-secondary)] mb-1">
                                        <span>Progress</span>
                                        <span>{{ getProjectStats(proj.id).percent }}%</span>
                                    </div>
                                    <div class="h-1.5 w-full bg-[var(--el-fill-color-dark)] rounded-full overflow-hidden">
                                        <div class="h-full bg-brand transition-all duration-500" :style="{ width: getProjectStats(proj.id).percent + '%' }"></div>
                                    </div>
                                    <div class="flex gap-3 mt-2">
                                        <div class="text-[10px] text-[var(--el-text-color-secondary)]">
                                            <span class="font-bold text-[var(--el-text-color-primary)]">{{ getProjectStats(proj.id).open }}</span> Open
                                        </div>
                                         <div class="text-[10px] text-[var(--el-text-color-secondary)]">
                                            <span class="font-bold text-[var(--el-text-color-primary)]">{{ getProjectStats(proj.id).done }}</span> Done
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <div v-if="activeTimer.running || activeTimer.paused" 
             class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 bg-[var(--el-bg-color)] shadow-xl border border-[var(--el-border-color)] rounded-full pl-1 pr-1 py-1 flex items-center gap-3 timer-active transition-all">
            
            <div class="w-8 h-8 rounded-full bg-brand flex items-center justify-center text-white font-mono text-xs font-bold">
               <el-icon class="animate-spin"><loading /></el-icon>
            </div>
            
            <div class="flex flex-col">
                <span class="text-[10px] text-[var(--el-text-color-secondary)] max-w-[120px] truncate leading-none mb-0.5">
                    {{ activeTimer.taskTitle }}
                </span>
                <span class="text-sm font-mono font-bold text-[var(--el-text-color-primary)] leading-none">
                    {{ formatTime(activeTimer.remaining) }}
                </span>
            </div>

            <div class="flex items-center border-l border-[var(--el-border-color)] pl-2">
                 <el-button circle text size="small" @click="toggleTimerPause">
                    <el-icon v-if="activeTimer.paused"><video-play /></el-icon>
                    <el-icon v-else><video-pause /></el-icon>
                 </el-button>
                 <el-button circle text type="danger" size="small" @click="stopTimer">
                    <el-icon><close /></el-icon>
                 </el-button>
            </div>
        </div>

        <el-dialog v-model="showProjectModal" title="New Project" width="400px" align-center append-to-body class="rounded-sm">
             <div class="space-y-4">
                <div class="flex gap-2">
                        <el-input v-model="newProject.title" placeholder="Project Name *" size="small" class="flex-1"></el-input>
                        <el-select v-model="newProject.type" placeholder="Type" class="w-32" size="small">
                        <el-option label="Design" value="Design"></el-option>
                        <el-option label="Dev" value="Development"></el-option>
                        <el-option label="Social" value="Social Media"></el-option>
                    </el-select>
                </div>
                
                <div class="flex gap-2">
                    <el-input v-model="newProject.owner" placeholder="Owner" size="small" class="flex-1">
                            <template #prefix><el-icon><user /></el-icon></template>
                    </el-input>
                    <el-input v-model="newProject.client" placeholder="Client" size="small" class="flex-1">
                        <template #prefix><el-icon><suitcase /></el-icon></template>
                    </el-input>
                </div>
                <el-input v-model="newProject.email" placeholder="Client Email" size="small">
                    <template #prefix><el-icon><message /></el-icon></template>
                </el-input>

                <el-button type="primary" class="w-full mt-1" size="small" @click="createProject" :disabled="!newProject.title">Add Project</el-button>
            </div>
        </el-dialog>

        <el-dialog v-model="showTagManager" title="Manage Tags" width="380px" align-center append-to-body>
            <div class="space-y-3">
                <div v-if="tags.length === 0" class="text-center text-[var(--el-text-color-secondary)] text-xs py-4 italic">
                    No tags defined. Add your own below.
                </div>
                <div v-else class="space-y-1.5 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                    <div v-for="(tag, index) in tags" :key="index" class="flex items-center justify-between p-1.5 rounded-sm bg-[var(--el-fill-color-light)] border border-[var(--el-border-color)]">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-sm bg-[var(--el-fill-color)] flex items-center justify-center border border-[var(--el-border-color)]">
                                <img :src="tag.iconPath" class="w-4 h-4 object-contain" @error="handleImgError" />
                            </div>
                            <span class="text-xs font-bold text-[var(--el-text-color-primary)]">{{ tag.label }}</span>
                        </div>
                        <el-button type="danger" icon="close" circle size="small" link @click="deleteTag(index)"></el-button>
                    </div>
                </div>

                <div class="pt-3 border-t border-[var(--el-border-color)]">
                    <label class="text-[10px] text-[var(--el-text-color-secondary)] mb-2 block uppercase font-bold">Select Icon (CDN)</label>
                    
                    <div class="grid grid-cols-8 gap-2 mb-3 max-h-32 overflow-y-auto custom-scrollbar p-1">
                        <div v-for="icon in availableIcons" :key="icon.name" 
                             @click="newTag.iconPath = icon.url; newTag.label = newTag.label || icon.name"
                             class="aspect-square rounded-sm border flex items-center justify-center cursor-pointer transition-all hover:bg-[var(--el-fill-color)]"
                             :class="newTag.iconPath === icon.url ? 'border-brand bg-brand/10 ring-1 ring-brand' : 'border-[var(--el-border-color)]'">
                             <img :src="icon.url" :title="icon.name" class="w-5 h-5 object-contain" />
                        </div>
                    </div>

                    <div class="flex gap-2 items-center">
                        <div class="w-8 h-8 shrink-0 border border-[var(--el-border-color)] rounded-sm flex items-center justify-center bg-[var(--el-fill-color)]">
                            <img v-if="newTag.iconPath" :src="newTag.iconPath" class="w-5 h-5 object-contain" />
                            <span v-else class="text-[8px] text-[var(--el-text-color-secondary)]">?</span>
                        </div>
                        <el-input v-model="newTag.label" placeholder="Label (e.g. YouTube)" size="small" class="flex-1"></el-input>
                    </div>
                    <el-button type="primary" class="w-full mt-2" size="small" @click="createTag" :disabled="!newTag.label || !newTag.iconPath">Add Tag</el-button>
                </div>
            </div>
        </el-dialog>

        <el-dialog v-model="showTaskModal" :title="editingTask ? 'Edit Item' : getModalTitle" width="480px" align-center append-to-body>
            <div class="space-y-4">
                
                <div>
                    <el-input v-model="taskForm.title" placeholder="What needs to be done?" size="default" class="!font-medium">
                        <template #prefix><el-icon class="text-[var(--el-text-color-placeholder)]"><edit /></el-icon></template>
                    </el-input>
                </div>
                
                <div v-if="editingTask && taskForm.itemType === 'task'" class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-sm border border-blue-100 dark:border-blue-900 flex items-center justify-between">
                     <div class="flex items-center gap-2 text-xs font-bold text-blue-600 dark:text-blue-400">
                        <el-icon><timer /></el-icon> Smart Focus
                     </div>
                     <div class="flex gap-2 items-center">
                         <div class="flex gap-1 items-center">
                             <el-input-number v-model="smartFocusSettings.amount" :min="1" size="small" controls-position="right" class="!w-16" :step="1"></el-input-number>
                             <el-select v-model="smartFocusSettings.unit" size="small" class="!w-20">
                                 <el-option label="Sec" value="s"></el-option>
                                 <el-option label="Min" value="m"></el-option>
                                 <el-option label="Hour" value="h"></el-option>
                             </el-select>
                         </div>
                         <el-button type="primary" size="small" icon="video-play" circle @click="startSmartTimer"></el-button>
                     </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[9px] uppercase font-bold text-[var(--el-text-color-secondary)] mb-1 block">Project</label>
                        <el-select v-model="taskForm.projectId" placeholder="Inbox" clearable class="w-full" size="small">
                            <el-option v-for="p in projects" :key="p.id" :label="p.title" :value="p.id"></el-option>
                        </el-select>
                    </div>
                    <div>
                        <label class="text-[9px] uppercase font-bold text-[var(--el-text-color-secondary)] mb-1 block">Date</label>
                        <el-date-picker v-model="taskForm.date" type="date" placeholder="Pick a day" format="YYYY-MM-DD" value-format="YYYY-MM-DD" style="width: 100%" size="small"></el-date-picker>
                    </div>
                </div>

                <div v-if="taskForm.itemType === 'task'" class="grid grid-cols-2 gap-3">
                     <div>
                        <label class="text-[9px] uppercase font-bold text-[var(--el-text-color-secondary)] mb-1 block">Recurrence</label>
                        <el-select v-model="taskForm.recurrence" class="w-full" size="small">
                            <el-option label="Once" value="once"></el-option>
                            <el-option label="Daily" value="daily"></el-option>
                            <el-option label="Weekly" value="weekly"></el-option>
                        </el-select>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                         <label class="text-[9px] uppercase font-bold text-[var(--el-text-color-secondary)] block">Tag</label>
                         <el-button type="primary" link size="small" @click="showTagManager = true" class="!text-[10px]">+ Manage</el-button>
                    </div>
                    
                    <div v-if="tags.length === 0" class="p-2 border border-dashed border-[var(--el-border-color)] rounded-sm text-center text-[10px] text-[var(--el-text-color-placeholder)]">
                        No tags found.
                    </div>
                    
                    <div v-else class="flex flex-wrap gap-1.5">
                        <div @click="taskForm.tagId = null"
                             class="px-2 py-1 rounded-sm cursor-pointer border text-[10px] font-bold transition-all"
                             :class="!taskForm.tagId ? 'border-brand bg-brand/10 text-brand' : 'border-[var(--el-border-color)] text-[var(--el-text-color-secondary)] hover:bg-[var(--el-fill-color)]'">
                            None
                        </div>
                        <div v-for="tag in tags" :key="tag.id"
                             @click="taskForm.tagId = tag.id"
                             class="px-2 py-1 rounded-sm cursor-pointer border text-[10px] font-bold transition-all flex items-center gap-1.5"
                             :class="taskForm.tagId === tag.id ? 'border-brand bg-brand/10 text-brand' : 'border-[var(--el-border-color)] text-[var(--el-text-color-secondary)] hover:bg-[var(--el-fill-color)]'">
                            <img :src="tag.iconPath" class="w-3 h-3 object-contain" @error="handleImgError" />
                            {{ tag.label }}
                        </div>
                    </div>
                </div>

                <div v-if="taskForm.itemType === 'task'" class="grid grid-cols-2 gap-3 bg-[var(--el-fill-color-light)] p-2 rounded-sm border border-[var(--el-border-color-lighter)]">
                     <div>
                        <label class="text-[9px] uppercase font-bold text-[var(--el-text-color-secondary)] mb-1 block">Time Est.</label>
                        <el-input v-model="taskForm.timeEstimate" placeholder="e.g. 1h" size="small"></el-input>
                    </div>
                    <div>
                        <label class="text-[9px] uppercase font-bold text-[var(--el-text-color-secondary)] mb-1 block">Status</label>
                        <el-select v-model="taskForm.status" class="w-full" size="small">
                            <el-option label="To Do" value="todo"></el-option>
                            <el-option label="In Progress" value="in_progress"></el-option>
                            <el-option label="Done" value="done"></el-option>
                        </el-select>
                    </div>
                </div>

                <div>
                     <label class="text-[9px] uppercase font-bold text-[var(--el-text-color-secondary)] mb-1 block">Description / Notes</label>
                     <el-input 
                        v-model="taskFormNotesStr" 
                        type="textarea" 
                        :autosize="{ minRows: 4, maxRows: 10 }" 
                        placeholder="Add details, notes, or ideas..."
                        class="text-xs"
                    ></el-input>
                </div>

                <div class="border-t border-[var(--el-border-color)] pt-3">
                     <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-bold text-[var(--el-text-color-secondary)]">Attachments</span>
                        <input type="file" ref="fileInput" @change="handleFileUpload" class="hidden" accept=".png,.jpg,.jpeg,.svg,.gif">
                        <el-button size="small" @click="$refs.fileInput.click()" :loading="uploading" link>
                            <el-icon class="mr-1"><paperclip /></el-icon> Add File
                        </el-button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                         <div v-for="(file, idx) in taskForm.files" :key="idx" class="text-[9px] bg-[var(--el-fill-color-dark)] text-[var(--el-text-color-regular)] px-2 py-1 rounded-sm flex items-center gap-1 border border-[var(--el-border-color)]">
                            <span class="max-w-[100px] truncate">{{ file.name }}</span>
                            <el-icon class="cursor-pointer hover:text-red-400" @click="removeFile(idx)"><close /></el-icon>
                         </div>
                    </div>
                </div>

            </div>
            <template #footer>
                <div class="flex justify-between w-full">
                    <el-button v-if="editingTask" type="danger" text size="small" @click="quickDeleteTask(taskForm.id, true)">Delete</el-button>
                    <div v-else></div>
                    <div class="flex gap-2">
                        <el-button @click="showTaskModal = false" size="small">Cancel</el-button>
                        <el-button type="primary" @click="saveTask" :loading="loading" size="small">Save</el-button>
                    </div>
                </div>
            </template>
        </el-dialog>

        <el-dialog v-model="showSettingsModal" title="Settings" width="450px" align-center append-to-body>
            <el-tabs>
                <el-tab-pane label="Workspace">
                     <div class="space-y-4 pt-2">
                        <div class="bg-blue-50 dark:bg-[#1e3a8a] p-3 rounded-sm border border-blue-100 dark:border-blue-900">
                            <h3 class="text-xs font-bold text-blue-600 dark:text-blue-300 flex items-center gap-2">
                                <el-icon><folder /></el-icon> GitHub Sync
                            </h3>
                            <p class="text-[9px] text-[var(--el-text-color-secondary)] mt-1">
                                Files stored in <code>PM_Dashboard/</code>
                            </p>
                        </div>
                        <div>
                            <div class="text-[10px] text-[var(--el-text-color-secondary)] mb-1">PAT Token</div>
                            <el-input v-model="ghSettings.token" type="password" placeholder="ghp_..." show-password size="small"></el-input>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <div class="text-[10px] text-[var(--el-text-color-secondary)] mb-1">Username</div>
                                <el-input v-model="ghSettings.owner" placeholder="username" size="small"></el-input>
                            </div>
                            <div>
                                <div class="text-[10px] text-[var(--el-text-color-secondary)] mb-1">Repository</div>
                                <el-input v-model="ghSettings.repo" placeholder="repository" size="small"></el-input>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-[var(--el-border-color)] mt-2 flex items-center justify-between">
                            <span class="text-[10px] text-[var(--el-text-color-secondary)] font-bold uppercase">Danger Zone</span>
                            <div class="flex gap-2">
                                <el-tooltip content="Wipe All JSON Data" placement="top">
                                    <el-button type="warning" circle size="small" @click="wipeRemoteData">
                                        <el-icon><delete /></el-icon>
                                    </el-button>
                                </el-tooltip>
                                <el-tooltip content="Disconnect & Logout" placement="top">
                                    <el-button type="danger" circle size="small" @click="clearStoredCredentials">
                                        <el-icon><switch-button /></el-icon>
                                    </el-button>
                                </el-tooltip>
                            </div>
                        </div>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="System">
                    <div class="space-y-4 pt-2">
                        <div>
                            <div class="text-[10px] text-[var(--el-text-color-secondary)] mb-1 font-bold">App Icon URL</div>
                            <div class="flex gap-2">
                                <div class="w-10 h-10 rounded-sm border border-[var(--el-border-color)] flex items-center justify-center bg-[var(--el-fill-color)] overflow-hidden shrink-0">
                                    <img v-if="appSettings.appIcon" :src="appSettings.appIcon" class="w-full h-full object-cover">
                                    <span v-else class="text-[10px] font-black">Nuu</span>
                                </div>
                                <el-input v-model="appSettings.appIcon" placeholder="https://..." size="small" class="flex-1"></el-input>
                            </div>
                            <p class="text-[9px] text-[var(--el-text-color-secondary)] mt-1">Updates <code>settings.json</code> & <code>manifest.json</code>.</p>
                        </div>
                        <div>
                             <div class="text-[10px] text-[var(--el-text-color-secondary)] mb-1 font-bold">Push Notifications</div>
                             <el-button size="small" @click="requestNotificationPerm" :disabled="notificationPermGranted">
                                {{ notificationPermGranted ? 'Enabled' : 'Enable Notifications' }}
                             </el-button>
                        </div>
                    </div>
                </el-tab-pane>
            </el-tabs>
           
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showSettingsModal = false" size="small">Cancel</el-button>
                    <el-button type="primary" @click="saveSettings" size="small">Connect/Save</el-button>
                </span>
            </template>
        </el-dialog>

    </div>
    
    <script>
        const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        
        const app = createApp({
            setup() {
                // State
                const notificationPermGranted = ref(Notification.permission === "granted");
                const isAppLoading = ref(true); 

                const loading = ref(false);
                const uploading = ref(false);
                const showSettingsModal = ref(false);
                const showTaskModal = ref(false);
                const showProjectModal = ref(false);
                const showTagManager = ref(false);
                const editingTask = ref(false);
                const activeFocusTask = ref(null); // The Expanded/Focused Task

                const viewMode = ref('timeline');
                const filterType = ref('all'); 
                
                // Calendar State
                const today = new Date();
                const viewDate = ref(new Date(today.getFullYear(), today.getMonth(), 1));

                // Timer State
                const activeTimer = reactive({
                    taskId: null,
                    taskTitle: '',
                    remaining: 0,
                    total: 0,
                    interval: null,
                    running: false,
                    paused: false
                });

                // Smart Focus Settings
                const smartFocusSettings = reactive({
                    amount: 25,
                    unit: 'm'
                });

                // Data
                const projects = ref([]);
                const tasks = ref([]);
                const tags = ref([]); 
                const files = ref([]); // File Registry
                const appSettings = reactive({ theme: 'dark', appIcon: '' });
                const fileSHAs = reactive({ projects: null, tasks: null, tags: null, settings: null, files: null, manifest: null });

                // --- CDN ICON LIBRARY (SimpleIcons) ---
                const availableIcons = ref([
                    { name: 'YouTube', url: 'https://cdn.simpleicons.org/youtube/FF0000' },
                    { name: 'Instagram', url: 'https://cdn.simpleicons.org/instagram/E4405F' },
                    { name: 'Twitter/X', url: 'https://cdn.simpleicons.org/x/888888' }, 
                    { name: 'LinkedIn', url: 'https://cdn.simpleicons.org/linkedin/0A66C2' },
                    { name: 'Figma', url: 'https://cdn.simpleicons.org/figma/F24E1E' },
                    { name: 'GitHub', url: 'https://cdn.simpleicons.org/github/888888' }
                ]);

                const ghSettings = reactive({
                    token: localStorage.getItem('gh_token') || '',
                    owner: localStorage.getItem('gh_owner') || '',
                    repo: localStorage.getItem('gh_repo') || '',
                    branch: 'main'
                });

                const taskForm = reactive({
                    id: null,
                    projectId: '',
                    itemType: 'task',
                    title: '',
                    date: '',
                    timeEstimate: '',
                    status: 'todo',
                    recurrence: 'once', 
                    notes: [], 
                    files: [],
                    tagId: null
                });

                const newProject = reactive({ 
                    title: '', 
                    type: 'Design',
                    owner: '',
                    client: '',
                    email: ''
                });

                const newTag = reactive({ iconPath: '', label: '' });

                // Computed
                const githubConfigured = computed(() => ghSettings.token && ghSettings.owner && ghSettings.repo);
                
                const filteredTasks = computed(() => {
                    if (filterType.value === 'all') return tasks.value;
                    return tasks.value.filter(t => t.itemType === filterType.value || (filterType.value === 'task' && t.itemType === 'idea'));
                });

                const getModalTitle = computed(() => {
                    if (taskForm.itemType === 'note') return 'New Note';
                    if (taskForm.itemType === 'idea') return 'New Idea';
                    return 'New Task';
                });

                // Computed property to handle Text Area <-> Array conversion for Modals
                const taskFormNotesStr = computed({
                    get: () => Array.isArray(taskForm.notes) ? taskForm.notes.join('\n') : '',
                    set: (val) => { taskForm.notes = val.split('\n'); }
                });

                // Computed property for the Focused Task View Text Area
                const focusTaskNotesComputed = computed({
                    get: () => {
                        if (activeFocusTask.value && Array.isArray(activeFocusTask.value.notes)) {
                            return activeFocusTask.value.notes.join('\n');
                        }
                        return '';
                    },
                    set: (val) => {
                        if (activeFocusTask.value) {
                            activeFocusTask.value.notes = val.split('\n');
                        }
                    }
                });

                // Helper for Local Date String (YYYY-MM-DD)
                const toDateStr = (d) => {
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                const generateId = () => {
                    if (typeof uuidv4 === 'function') return uuidv4();
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }

                // NOTIFICATION LOGIC
                const notificationList = computed(() => {
                    const todayStr = toDateStr(new Date());
                    return tasks.value.filter(t => {
                        return t.status !== 'done' && t.date <= todayStr;
                    }).map(t => ({
                        ...t,
                        isOverdue: t.date < todayStr
                    })).sort((a, b) => a.date.localeCompare(b.date));
                });

                const calendarDays = computed(() => {
                    const year = viewDate.value.getFullYear();
                    const month = viewDate.value.getMonth();
                    const days = [];
                    const lastDay = new Date(year, month + 1, 0).getDate();
                    for(let i = 1; i <= lastDay; i++) {
                        const d = new Date(year, month, i);
                        days.push({
                            dateObj: d,
                            dateStr: toDateStr(d),
                            dayName: d.toLocaleDateString('en-US', { weekday: 'short' }),
                            displayDate: d.getDate(),
                            isToday: d.toDateString() === new Date().toDateString()
                        });
                    }
                    return days;
                });

                const listViewGroups = computed(() => {
                    const sorted = [...filteredTasks.value].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const groups = {};
                    sorted.forEach(t => {
                        if (!groups[t.date]) groups[t.date] = [];
                        groups[t.date].push(t);
                    });
                    return Object.keys(groups).sort().map(date => {
                         const [y, m, d] = date.split('-').map(Number);
                         const dateObj = new Date(y, m - 1, d);
                         return {
                             dateLabel: dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' }),
                             tasks: groups[date]
                         }
                    });
                });

                // --- Methods ---

                const toggleTheme = () => {
                    appSettings.theme = appSettings.theme === 'dark' ? 'light' : 'dark';
                    applyTheme();
                    saveFile('PM_Dashboard/settings.json', appSettings, 'settings');
                };
                
                const applyTheme = () => {
                     if(appSettings.theme === 'dark') document.documentElement.classList.add('dark');
                     else document.documentElement.classList.remove('dark');
                };

                const changeMonth = (delta) => {
                    const d = new Date(viewDate.value);
                    d.setMonth(d.getMonth() + delta);
                    viewDate.value = d;
                };

                const goToToday = () => {
                    const now = new Date();
                    viewDate.value = new Date(now.getFullYear(), now.getMonth(), 1); 
                    if(viewMode.value === 'timeline') {
                        const todayStr = toDateStr(now);
                        nextTick(() => {
                            const container = document.getElementById('timelineScrollContainer');
                            const el = document.getElementById('day-' + todayStr);
                            if(container && el) {
                                const scrollLeft = el.offsetLeft - (container.clientWidth / 2) + (el.clientWidth / 2);
                                container.scrollTo({ left: scrollLeft, behavior: 'smooth' });
                                el.classList.add('flash-highlight');
                                setTimeout(() => el.classList.remove('flash-highlight'), 1500);
                            }
                        });
                    }
                };

                // --- Focus Mode Logic ---
                const toggleFocusMode = (task) => {
                    activeFocusTask.value = task;
                };

                const closeFocusMode = () => {
                    activeFocusTask.value = null;
                };

                const saveFocusTask = async () => {
                    if(!activeFocusTask.value) return;
                    
                    // Update main list
                    const updated = tasks.value.map(t => t.id === activeFocusTask.value.id ? {...activeFocusTask.value} : t);
                    tasks.value = updated;
                    
                    // Autosave silently
                    try {
                        await saveFile('PM_Dashboard/tasks.json', updated, 'tasks');
                    } catch(e) {}
                };

                
                // --- Smart Timer Logic ---
                const startSmartTimer = () => {
                    const amount = smartFocusSettings.amount;
                    const unit = smartFocusSettings.unit;

                    if (!amount || amount <= 0) {
                         ElMessage.warning("Please enter a valid time.");
                         return;
                    }

                    let seconds = 0;
                    if(unit === 's') seconds = amount;
                    if(unit === 'm') seconds = amount * 60;
                    if(unit === 'h') seconds = amount * 3600;

                    if (activeTimer.interval) clearInterval(activeTimer.interval);
                    
                    activeTimer.taskId = taskForm.id;
                    activeTimer.taskTitle = taskForm.title || 'Untitled Task';
                    activeTimer.total = seconds;
                    activeTimer.remaining = seconds;
                    activeTimer.running = true;
                    activeTimer.paused = false;

                    activeTimer.interval = setInterval(() => {
                        if(!activeTimer.paused) {
                            activeTimer.remaining--;
                            if (activeTimer.remaining <= 0) {
                                finishTimer();
                            }
                        }
                    }, 1000);
                    
                    showTaskModal.value = false;
                    ElMessage.success(`Focus timer started: ${amount}${unit}`);
                };
                
                const quickStartTimer = (task) => {
                    if (activeTimer.running && activeTimer.taskId !== task.id) {
                         ElMessageBox.confirm('A timer is already running. Stop it and start new?', 'Timer Active', {
                            confirmButtonText: 'Yes, Start New',
                            cancelButtonText: 'Cancel'
                        }).then(() => {
                            _startTimerForTask(task);
                        }).catch(()=>{});
                    } else {
                        _startTimerForTask(task);
                    }
                }

                const _startTimerForTask = (task) => {
                    taskForm.id = task.id;
                    taskForm.title = task.title;
                    smartFocusSettings.amount = 25; // Default to pomodoro
                    smartFocusSettings.unit = 'm';
                    startSmartTimer();
                }

                const toggleTimerPause = () => {
                    activeTimer.paused = !activeTimer.paused;
                };

                const stopTimer = () => {
                    if (activeTimer.interval) clearInterval(activeTimer.interval);
                    activeTimer.running = false;
                    activeTimer.taskId = null;
                };

                const finishTimer = () => {
                    stopTimer();
                    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 
                    audio.play().catch(e => console.log('Audio play failed', e));

                    if (Notification.permission === "granted") {
                        new Notification("Time's Up!", {
                            body: `Focus session for "${activeTimer.taskTitle}" is complete.`,
                            icon: appSettings.appIcon || ''
                        });
                    } else {
                        ElMessageBox.alert(`Time is up for ${activeTimer.taskTitle}!`, 'Focus Complete');
                    }
                };

                const formatTime = (seconds) => {
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                    const s = (seconds % 60).toString().padStart(2, '0');
                    if (h > 0) return `${h}:${m}:${s}`;
                    return `${m}:${s}`;
                };

                const requestNotificationPerm = () => {
                    Notification.requestPermission().then(permission => {
                        notificationPermGranted.value = permission === "granted";
                        if(permission === "granted") ElMessage.success("Notifications Enabled");
                    });
                };
                
                // --- Manifest Logic ---
                const updateManifestLink = () => {
                    const manifest = {
                        name: "Nuudesk",
                        short_name: "Nuudesk",
                        display: "standalone",
                        start_url: ".",
                        background_color: "#1a1a1a",
                        theme_color: "#2563EB",
                        icons: [{
                            src: appSettings.appIcon || 'https://cdn.simpleicons.org/googleearth/2563EB',
                            sizes: "192x192",
                            type: "image/png"
                        }]
                    };
                    const stringManifest = JSON.stringify(manifest);
                    const blob = new Blob([stringManifest], {type: 'application/json'});
                    const manifestURL = URL.createObjectURL(blob);
                    document.querySelector('#app-manifest').setAttribute('href', manifestURL);
                };

                // --- GitHub API ---
                const ghApi = async (path, method = 'GET', body = null) => {
                    const url = `https://api.github.com/repos/${ghSettings.owner}/${ghSettings.repo}/contents/${path}`;
                    const headers = {
                        'Authorization': `token ${ghSettings.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    };
                    const options = { method, headers };
                    if (body) options.body = JSON.stringify(body);
                    return await fetch(url, options);
                };

                const initDashboard = async () => {
                    if (!githubConfigured.value) {
                        isAppLoading.value = false;
                        return;
                    }
                    loading.value = true;
                    try {
                        const fileList = ['projects', 'tasks', 'tags', 'settings', 'files', 'manifest'];
                        await Promise.all(fileList.map(async (file) => {
                            try {
                                const res = await ghApi(`PM_Dashboard/${file}.json`);
                                if(res.ok) {
                                    const data = await res.json();
                                    fileSHAs[file] = data.sha;
                                    let content = JSON.parse(atob(data.content));
                                    
                                    if(file === 'projects') projects.value = content;
                                    if(file === 'tasks') tasks.value = content; 
                                    if(file === 'tags') tags.value = content;
                                    if(file === 'files') files.value = content;
                                    if(file === 'settings') {
                                        Object.assign(appSettings, content);
                                        applyTheme();
                                        updateManifestLink();
                                    }
                                } else if (res.status === 404) {
                                    let defaultData = [];
                                    if(file === 'settings') defaultData = { theme: 'dark', appIcon: '' };
                                    if(file === 'manifest') defaultData = { name: "Nuudesk", icons: [] };
                                    await saveFile(`PM_Dashboard/${file}.json`, defaultData, file);
                                }
                            } catch(e) { console.error(e); }
                        }));
                        
                        setTimeout(() => {
                             isAppLoading.value = false;
                             ElMessage.success("Synced");
                        }, 800);

                    } catch (e) {
                        isAppLoading.value = false;
                        ElMessage.error("Sync Failed");
                    } finally {
                        loading.value = false;
                    }
                };

                const saveFile = async (path, data, type) => {
                    const content = btoa(JSON.stringify(data, null, 2));
                    const body = { message: `Update ${type}`, content, branch: ghSettings.branch };
                    if (fileSHAs[type]) body.sha = fileSHAs[type];
                    
                    try {
                        const res = await ghApi(path, 'PUT', body);
                        if (!res.ok) throw new Error('GitHub Save Failed');
                        const resData = await res.json();
                        fileSHAs[type] = resData.content.sha;
                        
                        if (type === 'projects') projects.value = data;
                        if (type === 'tasks') tasks.value = data;
                        if (type === 'tags') tags.value = data;
                        if (type === 'settings') { Object.assign(appSettings, data); applyTheme(); }
                        if (type === 'files') files.value = data;
                    } catch(e) { console.error(e); }
                };

                // --- Tag Manager Logic ---
                const createTag = async () => {
                    const t = { id: generateId(), iconPath: newTag.iconPath, label: newTag.label };
                    loading.value = true;
                    try {
                        await saveFile('PM_Dashboard/tags.json', [...tags.value, t], 'tags');
                        newTag.iconPath = '';
                        newTag.label = '';
                    } catch(e) { ElMessage.error("Failed to save tag"); }
                    loading.value = false;
                };

                const deleteTag = async (index) => {
                    const newTags = [...tags.value];
                    newTags.splice(index, 1);
                    loading.value = true;
                    await saveFile('PM_Dashboard/tags.json', newTags, 'tags');
                    loading.value = false;
                };
                
                const getTagName = (id) => tags.value.find(t => t.id === id)?.label || '';
                const getTagIcon = (id) => tags.value.find(t => t.id === id)?.iconPath || ''; 
                const handleImgError = (e) => e.target.style.display = 'none';

                // --- CRUD ---
                const openTaskModal = (dateStr = null, type = 'task') => {
                    editingTask.value = false;
                    Object.assign(taskForm, {
                        id: generateId(),
                        projectId: '',
                        itemType: type, 
                        title: '',
                        date: dateStr || toDateStr(new Date()),
                        timeEstimate: '',
                        status: 'todo',
                        recurrence: 'once',
                        notes: [],
                        files: [],
                        tagId: null
                    });
                    showTaskModal.value = true;
                };

                const editTask = (task) => {
                    editingTask.value = true;
                    const data = JSON.parse(JSON.stringify(task));
                    if(!data.recurrence) data.recurrence = 'once';
                    if (!Array.isArray(data.notes)) data.notes = data.notes ? [data.notes] : [];
                    Object.assign(taskForm, data);
                    showTaskModal.value = true;
                };

                const saveTask = async () => {
                    if(!taskForm.title || !taskForm.date) return ElMessage.warning("Title and Date required");
                    loading.value = true;
                    
                    // Filter empty lines done by computed set implicitly or explicit here if needed
                    // taskForm.notes = taskForm.notes.filter(n => n.trim() !== '');

                    const updated = editingTask.value 
                        ? tasks.value.map(t => t.id === taskForm.id ? {...taskForm} : t)
                        : [...tasks.value, {...taskForm}];

                    try {
                        await saveFile('PM_Dashboard/tasks.json', updated, 'tasks');
                        showTaskModal.value = false;
                        ElMessage.success("Item Saved");
                    } catch(e) { ElMessage.error(e.message); }
                    loading.value = false;
                };

                const cloneTask = async (task) => {
                    const cloned = JSON.parse(JSON.stringify(task));
                    cloned.id = generateId();
                    cloned.title = cloned.title + ' (Copy)';
                    loading.value = true;
                    try {
                        await saveFile('PM_Dashboard/tasks.json', [...tasks.value, cloned], 'tasks');
                        ElMessage.success("Task Cloned");
                    } catch(e) { ElMessage.error("Failed to clone"); }
                    loading.value = false;
                }

                const createProject = async () => {
                    const newP = { 
                        id: generateId(), 
                        title: newProject.title, 
                        type: newProject.type, 
                        owner: newProject.owner, 
                        client: newProject.client, 
                        email: newProject.email 
                    };
                    loading.value = true;
                    try {
                        await saveFile('PM_Dashboard/projects.json', [...projects.value, newP], 'projects');
                        newProject.title = '';
                        newProject.owner = '';
                        newProject.client = '';
                        newProject.email = '';
                        showProjectModal.value = false;
                        ElMessage.success("Project Created");
                    } catch(e) {}
                    loading.value = false;
                };

                const deleteProject = async (id) => {
                    ElMessageBox.confirm(
                        'Are you sure you want to delete this project?',
                        'Warning',
                        { confirmButtonText: 'Delete', cancelButtonText: 'Cancel', type: 'warning' }
                    ).then(async () => {
                        loading.value = true;
                        await saveFile('PM_Dashboard/projects.json', projects.value.filter(p => p.id !== id), 'projects');
                        loading.value = false;
                        ElMessage.success("Project Deleted");
                    }).catch(() => {});
                };
                
                const quickDeleteTask = async (id, closeModals = false) => {
                    ElMessageBox.confirm(
                        'Permanently delete this item?',
                        'Warning',
                        { confirmButtonText: 'Delete', cancelButtonText: 'Cancel', type: 'warning' }
                    ).then(async () => {
                        loading.value = true;
                        await saveFile('PM_Dashboard/tasks.json', tasks.value.filter(t => t.id !== id), 'tasks');
                        loading.value = false;
                        ElMessage.success("Deleted");
                        
                        if (closeModals) showTaskModal.value = false;
                        if (activeFocusTask.value && activeFocusTask.value.id === id) activeFocusTask.value = null;

                    }).catch(() => {});
                }

                // --- Data Management ---
                const wipeRemoteData = async () => {
                     ElMessageBox.confirm(
                        'This will delete all JSON Data from GitHub.',
                        'Warning',
                        { confirmButtonText: 'Yes, Wipe', cancelButtonText: 'Cancel', type: 'warning' }
                    ).then(async () => {
                        loading.value = true;
                        try {
                            const filesToWipe = ['tasks', 'projects', 'tags', 'files', 'settings'];
                            for(const f of filesToWipe) {
                                await saveFile(`PM_Dashboard/${f}.json`, [], f);
                            }
                            ElMessage.success("Data wiped.");
                        } catch(e) { ElMessage.error("Failed to wipe data"); }
                        loading.value = false;
                    }).catch(() => {});
                };

                const clearStoredCredentials = () => {
                    ElMessageBox.confirm(
                        'Disconnect and remove credentials from this browser?',
                        'Disconnect',
                        { confirmButtonText: 'Yes, Disconnect', cancelButtonText: 'Cancel', type: 'warning' }
                    ).then(() => {
                        localStorage.removeItem('gh_token');
                        localStorage.removeItem('gh_owner');
                        localStorage.removeItem('gh_repo');
                        window.location.reload();
                    }).catch(() => {});
                };

                const saveSettings = async () => {
                    localStorage.setItem('gh_token', ghSettings.token);
                    localStorage.setItem('gh_owner', ghSettings.owner);
                    localStorage.setItem('gh_repo', ghSettings.repo);
                    
                    await saveFile('PM_Dashboard/settings.json', appSettings, 'settings');
                    
                    const manifest = {
                        name: "Nuudesk",
                        short_name: "Nuudesk",
                        display: "standalone",
                        start_url: ".",
                        background_color: "#1a1a1a",
                        theme_color: "#2563EB",
                        icons: [{
                            src: appSettings.appIcon || 'https://cdn.simpleicons.org/googleearth/2563EB',
                            sizes: "192x192",
                            type: "image/png"
                        }]
                    };
                    await saveFile('PM_Dashboard/manifest.json', manifest, 'manifest');
                    
                    updateManifestLink();
                    showSettingsModal.value = false;
                    initDashboard();
                };

                const toggleStatus = (task) => {
                    const isDone = task.status === 'done';
                    if (task.recurrence && task.recurrence !== 'once' && !isDone) {
                        const confirmNext = confirm(`Mark done? This will reschedule the task to next ${task.recurrence === 'daily' ? 'day' : 'week'}.`);
                        if(!confirmNext) return;

                        const nextDate = new Date(task.date);
                        if (task.recurrence === 'daily') nextDate.setDate(nextDate.getDate() + 1);
                        else if (task.recurrence === 'weekly') nextDate.setDate(nextDate.getDate() + 7);
                        
                        const t = tasks.value.find(x => x.id === task.id);
                        if(t) {
                            t.date = toDateStr(nextDate);
                            t.status = 'todo'; 
                        }
                        ElMessage.success("Task completed & rescheduled.");
                    } 
                    else {
                        const newStatus = isDone ? 'todo' : 'done';
                        const t = tasks.value.find(x => x.id === task.id);
                        if(t) t.status = newStatus;
                    }
                    saveFile('PM_Dashboard/tasks.json', tasks.value, 'tasks');
                };

                // --- Helpers ---
                const handleFileUpload = async (e) => {
                    const file = e.target.files[0];
                    if(!file) return;
                    
                    const fileName = file.name;
                    const path = `PM_Dashboard/files/${fileName}`;
                    let shaToOverwrite = null;

                    uploading.value = true;
                    try {
                        const checkRes = await ghApi(path);
                        if(checkRes.ok) {
                            uploading.value = false;
                            try {
                                await ElMessageBox.confirm(
                                    `File "${fileName}" already exists. Overwrite?`,
                                    'Duplicate',
                                    { confirmButtonText: 'Overwrite', cancelButtonText: 'Cancel', type: 'warning' }
                                );
                                const data = await checkRes.json();
                                shaToOverwrite = data.sha;
                                uploading.value = true; 
                            } catch (cancel) {
                                e.target.value = ''; 
                                return;
                            }
                        }
                    } catch(err) {}

                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                         const content = ev.target.result.split(',')[1];
                         const body = { message: `Upload ${fileName}`, content, branch: ghSettings.branch };
                         if(shaToOverwrite) body.sha = shaToOverwrite;

                         try {
                             const res = await ghApi(path, 'PUT', body);
                             if(!res.ok) throw new Error("Upload Failed");
                             
                             const existsInTask = taskForm.files.find(f => f.path === path);
                             if(!existsInTask) {
                                 taskForm.files.push({ name: file.name, path: path });
                             }
                             
                             const newFileEntry = { name: fileName, path: path, uploadedAt: new Date().toISOString() };
                             const updatedFiles = [...files.value, newFileEntry];
                             await saveFile('PM_Dashboard/files.json', updatedFiles, 'files');

                             ElMessage.success(shaToOverwrite ? "File Overwritten" : "File Uploaded");
                         } catch(err) { ElMessage.error("Upload error"); }
                         uploading.value = false;
                         e.target.value = '';
                    };
                    reader.readAsDataURL(file);
                };

                const removeFile = (i) => taskForm.files.splice(i, 1);
                const getTasksForDate = (d) => filteredTasks.value.filter(t => t.date === d);
                const getProjectName = (id) => projects.value.find(p => p.id === id)?.title || 'Unassigned';
                const getProjectTypeColor = (id) => {
                    const p = projects.value.find(p => p.id === id);
                    if(!p) return 'text-[var(--el-text-color-secondary)] bg-[var(--el-fill-color)]';
                    if(p.type === 'Design') return 'text-brand bg-brand/10';
                    if(p.type === 'Social Media') return 'text-pink-500 bg-pink-500/10';
                    return 'text-blue-500 bg-blue-500/10';
                };
                
                const getProjectStats = (pid) => {
                    const pTasks = tasks.value.filter(t => t.projectId === pid);
                    const total = pTasks.length;
                    const done = pTasks.filter(t => t.status === 'done').length;
                    return {
                        total,
                        done,
                        open: total - done,
                        percent: total > 0 ? Math.round((done / total) * 100) : 0
                    };
                };

                onMounted(() => {
                    if(githubConfigured.value) initDashboard();
                    else {
                        isAppLoading.value = false;
                        showSettingsModal.value = true;
                    }
                });

                return {
                    appSettings, toggleTheme, loading, uploading, viewMode, viewDate, filterType,
                    showSettingsModal, showTaskModal, showProjectModal, showTagManager,
                    editingTask, projects, calendarDays, tasks, tags, listViewGroups, availableIcons,
                    ghSettings, githubConfigured, taskForm, newProject, newTag,
                    notificationList, notificationPermGranted, getModalTitle,
                    activeTimer, smartFocusSettings, isAppLoading, activeFocusTask, focusTaskNotesComputed, taskFormNotesStr,
                    openTaskModal, editTask, saveTask, createProject, deleteProject, createTag, deleteTag,
                    saveSettings, wipeRemoteData, clearStoredCredentials, handleFileUpload, removeFile,
                    changeMonth, getTasksForDate, getProjectName, getProjectTypeColor, getTagName, getTagIcon, getProjectStats,
                    handleImgError, toggleStatus, toggleFocusMode, closeFocusMode, saveFocusTask,
                    goToToday,
                    requestNotificationPerm, startSmartTimer, stopTimer, toggleTimerPause, formatTime, quickStartTimer,
                    cloneTask, quickDeleteTask
                };
            }
        });
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) app.component(key, component);
        app.use(ElementPlus); 
        app.mount('#app');
    </script>
</body>
</html>